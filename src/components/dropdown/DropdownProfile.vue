<template>
  <div class="relative inline-flex">
    <div
      ref="trigger"
      class="flex items-center cursor-pointer"
      aria-label="Select date range"
      aria-haspopup="true"
      :aria-expanded="dropdownOpen"
      @click.prevent="dropdownOpen = !dropdownOpen"
    >
      <svg class="mr-2.5" width="38" height="38" viewBox="0 0 38 38" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g clip-path="url(#clip0_4001_126795)">
          <g clip-path="url(#clip1_4001_126795)">
            <path d="M26.125 14.25C26.125 16.1397 25.3743 17.9519 24.0381 19.2881C22.7019 20.6243 20.8897 21.375 19 21.375C17.1103 21.375 15.2981 20.6243 13.9619 19.2881C12.6257 17.9519 11.875 16.1397 11.875 14.25C11.875 12.3603 12.6257 10.5481 13.9619 9.21186C15.2981 7.87567 17.1103 7.125 19 7.125C20.8897 7.125 22.7019 7.87567 24.0381 9.21186C25.3743 10.5481 26.125 12.3603 26.125 14.25Z" fill="#808894"/>
            <path fill-rule="evenodd" clip-rule="evenodd" d="M0 19C0 13.9609 2.00178 9.12816 5.56497 5.56497C9.12816 2.00178 13.9609 0 19 0C24.0391 0 28.8718 2.00178 32.435 5.56497C35.9982 9.12816 38 13.9609 38 19C38 24.0391 35.9982 28.8718 32.435 32.435C28.8718 35.9982 24.0391 38 19 38C13.9609 38 9.12816 35.9982 5.56497 32.435C2.00178 28.8718 0 24.0391 0 19ZM19 2.375C15.8692 2.37517 12.8021 3.25936 10.1517 4.92582C7.50129 6.59227 5.3753 8.97325 4.01841 11.7947C2.66153 14.6162 2.12892 17.7634 2.48187 20.8742C2.83482 23.9851 4.059 26.933 6.0135 29.3787C7.69975 26.6617 11.4119 23.75 19 23.75C26.5881 23.75 30.2979 26.6594 31.9865 29.3787C33.941 26.933 35.1652 23.9851 35.5181 20.8742C35.8711 17.7634 35.3385 14.6162 33.9816 11.7947C32.6247 8.97325 30.4987 6.59227 27.8483 4.92582C25.1979 3.25936 22.1308 2.37517 19 2.375Z" fill="#808894"/>
          </g>
        </g>
        <defs>
        <clipPath id="clip0_4001_126795">
          <rect width="38" height="38" rx="19" fill="white"/>
        </clipPath>
        <clipPath id="clip1_4001_126795">
          <rect width="38" height="38" fill="white"/>
        </clipPath>
        </defs>
      </svg>
      <span class="text-gray-800 text-sm">{{ client?.shortName || 'USER' }}</span>
    </div>
    <transition
      enter-active-class="transition ease-out duration-100 transform"
      enter-from-class="opacity-0 -translate-y-2"
      enter-to-class="opacity-100 translate-y-0"
      leave-active-class="transition ease-out duration-100"
      leave-from-class="opacity-100"
      leave-to-class="opacity-0"
    >
      <div v-show="dropdownOpen" class="z-10 absolute right-0 min-w-[234px] w-full top-full bg-white border border-gray-200 pb-1.5 rounded-lg shadow-lg overflow-hidden mt-1">
        <div
          v-if="client"
          ref="dropdown"
          class="font-medium text-sm text-gray-600"
          @focusin="dropdownOpen = true"
          @focusout="dropdownOpen = false"
        >
          <div class="text-sm font-medium text-gray-800 bg-gray-100 py-2 px-5 mb-2">+{{ client.contact.phone }}</div>
          <router-link to="/account/settings" custom v-slot="{ navigate }">
            <a class="flex items-center h-9 cursor-pointer px-5 mb-1 hover:bg-gray-50" @click="navigate(), dropdownOpen = !dropdownOpen">
              <div class="w-[28px]">
                <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M6 6C6.79565 6 7.55871 5.68393 8.12132 5.12132C8.68393 4.55871 9 3.79565 9 3C9 2.20435 8.68393 1.44129 8.12132 0.87868C7.55871 0.316071 6.79565 0 6 0C5.20435 0 4.44129 0.316071 3.87868 0.87868C3.31607 1.44129 3 2.20435 3 3C3 3.79565 3.31607 4.55871 3.87868 5.12132C4.44129 5.68393 5.20435 6 6 6ZM8 3C8 3.53043 7.78929 4.03914 7.41421 4.41421C7.03914 4.78929 6.53043 5 6 5C5.46957 5 4.96086 4.78929 4.58579 4.41421C4.21071 4.03914 4 3.53043 4 3C4 2.46957 4.21071 1.96086 4.58579 1.58579C4.96086 1.21071 5.46957 1 6 1C6.53043 1 7.03914 1.21071 7.41421 1.58579C7.78929 1.96086 8 2.46957 8 3ZM12 11C12 12 11 12 11 12H1C1 12 0 12 0 11C0 10 1 7 6 7C11 7 12 10 12 11ZM11 10.996C10.999 10.75 10.846 10.01 10.168 9.332C9.516 8.68 8.289 8 6 8C3.71 8 2.484 8.68 1.832 9.332C1.154 10.01 1.002 10.75 1 10.996H11Z" fill="#1F2937"/>
                </svg>
              </div>
              <span class="text-sm font-medium text-gray-800">Account settings</span>
            </a>
          </router-link>
          <router-link to="/account/payment-methods" custom v-slot="{ navigate }">
            <a class="flex items-center h-9 cursor-pointer px-5 mb-1 hover:bg-gray-50" @click="navigate(), dropdownOpen = !dropdownOpen">
              <div class="w-[28px]">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M0 4C0 3.46957 0.210714 2.96086 0.585786 2.58579C0.960859 2.21071 1.46957 2 2 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V12C16 12.5304 15.7893 13.0391 15.4142 13.4142C15.0391 13.7893 14.5304 14 14 14H2C1.46957 14 0.960859 13.7893 0.585786 13.4142C0.210714 13.0391 0 12.5304 0 12V4ZM2 3C1.73478 3 1.48043 3.10536 1.29289 3.29289C1.10536 3.48043 1 3.73478 1 4V5H15V4C15 3.73478 14.8946 3.48043 14.7071 3.29289C14.5196 3.10536 14.2652 3 14 3H2ZM15 7H1V12C1 12.2652 1.10536 12.5196 1.29289 12.7071C1.48043 12.8946 1.73478 13 2 13H14C14.2652 13 14.5196 12.8946 14.7071 12.7071C14.8946 12.5196 15 12.2652 15 12V7Z" fill="#1F2937"/>
                  <path d="M2 10C2 9.73478 2.10536 9.48043 2.29289 9.29289C2.48043 9.10536 2.73478 9 3 9H4C4.26522 9 4.51957 9.10536 4.70711 9.29289C4.89464 9.48043 5 9.73478 5 10V11C5 11.2652 4.89464 11.5196 4.70711 11.7071C4.51957 11.8946 4.26522 12 4 12H3C2.73478 12 2.48043 11.8946 2.29289 11.7071C2.10536 11.5196 2 11.2652 2 11V10Z" fill="#1F2937"/>
                </svg>
              </div>
              <span class="text-sm font-medium text-gray-800">Payment methods</span>
            </a>
          </router-link>
          <router-link to="/account/security" custom v-slot="{ navigate }">
            <a class="flex items-center h-9 cursor-pointer px-5 mb-1 hover:bg-gray-50" @click="navigate(), dropdownOpen = !dropdownOpen">
              <div class="w-[28px]">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <g clip-path="url(#clip0_4202_126359)">
                    <path d="M3.03393e-07 8.00009C-0.000342641 7.11927 0.290063 6.26296 0.826149 5.56406C1.36224 4.86516 2.11402 4.36275 2.96484 4.1348C3.81566 3.90685 4.71793 3.96611 5.53162 4.30339C6.34531 4.64066 7.02493 5.23708 7.465 6.00009H14C14.0657 5.99998 14.1308 6.01281 14.1915 6.03786C14.2523 6.06291 14.3075 6.09969 14.354 6.14609L15.854 7.64609C15.9006 7.69254 15.9375 7.74771 15.9627 7.80846C15.9879 7.86921 16.0009 7.93433 16.0009 8.00009C16.0009 8.06586 15.9879 8.13098 15.9627 8.19173C15.9375 8.25247 15.9006 8.30765 15.854 8.35409L14.354 9.85409C14.3076 9.90066 14.2524 9.9376 14.1916 9.96281C14.1309 9.98801 14.0658 10.001 14 10.001C13.9342 10.001 13.8691 9.98801 13.8084 9.96281C13.7476 9.9376 13.6924 9.90066 13.646 9.85409L13 9.20709L12.354 9.85409C12.3076 9.90066 12.2524 9.9376 12.1916 9.96281C12.1309 9.98801 12.0658 10.001 12 10.001C11.9342 10.001 11.8691 9.98801 11.8084 9.96281C11.7476 9.9376 11.6924 9.90066 11.646 9.85409L11 9.20709L10.354 9.85409C10.3076 9.90066 10.2524 9.9376 10.1916 9.96281C10.1309 9.98801 10.0658 10.001 10 10.001C9.93423 10.001 9.86911 9.98801 9.80837 9.96281C9.74762 9.9376 9.69245 9.90066 9.646 9.85409L9 9.20709L8.354 9.85409C8.30748 9.9005 8.25227 9.93727 8.19153 9.96233C8.13079 9.98738 8.06571 10.0002 8 10.0001H7.465C7.02493 10.7631 6.34531 11.3595 5.53162 11.6968C4.71793 12.0341 3.81566 12.0933 2.96484 11.8654C2.11402 11.6374 1.36224 11.135 0.826149 10.4361C0.290063 9.73723 -0.000342641 8.88092 3.03393e-07 8.00009ZM4 5.00009C3.46314 5.0003 2.93617 5.14456 2.47407 5.41784C2.01197 5.69111 1.63166 6.08338 1.37283 6.55372C1.114 7.02407 0.98612 7.55525 1.00254 8.09186C1.01896 8.62847 1.17908 9.15084 1.46619 9.60448C1.7533 10.0581 2.15688 10.4264 2.63483 10.6709C3.11278 10.9154 3.64758 11.0272 4.18345 10.9945C4.71932 10.9619 5.23661 10.7861 5.68137 10.4854C6.12612 10.1847 6.48205 9.77021 6.712 9.28509C6.7526 9.19985 6.8165 9.12785 6.89631 9.07742C6.97613 9.02698 7.06859 9.00017 7.163 9.00009H7.793L8.646 8.14609C8.69245 8.09953 8.74762 8.06259 8.80837 8.03738C8.86911 8.01218 8.93423 7.9992 9 7.9992C9.06577 7.9992 9.13089 8.01218 9.19163 8.03738C9.25238 8.06259 9.30755 8.09953 9.354 8.14609L10 8.79309L10.646 8.14609C10.6924 8.09953 10.7476 8.06259 10.8084 8.03738C10.8691 8.01218 10.9342 7.9992 11 7.9992C11.0658 7.9992 11.1309 8.01218 11.1916 8.03738C11.2524 8.06259 11.3076 8.09953 11.354 8.14609L12 8.79309L12.646 8.14609C12.6924 8.09953 12.7476 8.06259 12.8084 8.03738C12.8691 8.01218 12.9342 7.9992 13 7.9992C13.0658 7.9992 13.1309 8.01218 13.1916 8.03738C13.2524 8.06259 13.3076 8.09953 13.354 8.14609L14 8.79309L14.793 8.00009L13.793 7.00009H7.163C7.06859 7.00002 6.97613 6.97321 6.89631 6.92277C6.8165 6.87234 6.7526 6.80033 6.712 6.71509C6.46869 6.2018 6.08466 5.76814 5.60456 5.46454C5.12446 5.16094 4.56804 4.99988 4 5.00009Z" fill="#1F2937"/>
                    <path d="M4 8C4 8.26522 3.89464 8.51957 3.70711 8.70711C3.51957 8.89464 3.26522 9 3 9C2.73478 9 2.48043 8.89464 2.29289 8.70711C2.10536 8.51957 2 8.26522 2 8C2 7.73478 2.10536 7.48043 2.29289 7.29289C2.48043 7.10536 2.73478 7 3 7C3.26522 7 3.51957 7.10536 3.70711 7.29289C3.89464 7.48043 4 7.73478 4 8Z" fill="#1F2937"/>
                  </g>
                  <defs>
                    <clipPath id="clip0_4202_126359">
                      <rect width="16" height="16" fill="white"/>
                    </clipPath>
                  </defs>
                </svg>
              </div>
              <span class="text-sm font-medium text-gray-800">Security settings</span>
            </a>
          </router-link>
          <router-link to="/account/notification" custom v-slot="{ navigate }">
            <a class="flex items-center h-9 cursor-pointer px-5 hover:bg-gray-50" @click="navigate(), dropdownOpen = !dropdownOpen">
              <div class="w-[28px]">
                <svg width="14" height="16" viewBox="0 0 14 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M7 15.9999C7.53043 15.9999 8.03914 15.7892 8.41421 15.4141C8.78929 15.039 9 14.5303 9 13.9999H5C5 14.5303 5.21071 15.039 5.58579 15.4141C5.96086 15.7892 6.46957 15.9999 7 15.9999ZM7 1.9179L6.203 2.0789C5.29896 2.2631 4.48633 2.754 3.90265 3.46852C3.31897 4.18304 3.0001 5.07728 3 5.9999C3 6.6279 2.866 8.1969 2.541 9.7419C2.381 10.5089 2.165 11.3079 1.878 11.9999H12.122C11.835 11.3079 11.62 10.5099 11.459 9.7419C11.134 8.1969 11 6.6279 11 5.9999C10.9997 5.07746 10.6807 4.18345 10.097 3.46913C9.51337 2.75482 8.70087 2.26406 7.797 2.0799L7 1.9169V1.9179ZM13.22 11.9999C13.443 12.4469 13.701 12.8009 14 12.9999H0C0.299 12.8009 0.557 12.4469 0.78 11.9999C1.68 10.1999 2 6.8799 2 5.9999C2 3.5799 3.72 1.5599 6.005 1.0989C5.99104 0.959852 6.00638 0.819425 6.05003 0.686672C6.09368 0.553919 6.16467 0.431788 6.25842 0.328156C6.35217 0.224525 6.4666 0.141693 6.59433 0.0850029C6.72206 0.0283129 6.86026 -0.000976562 7 -0.000976562C7.13974 -0.000976563 7.27794 0.0283129 7.40567 0.0850029C7.5334 0.141693 7.64783 0.224525 7.74158 0.328156C7.83533 0.431788 7.90632 0.553919 7.94997 0.686672C7.99362 0.819425 8.00896 0.959852 7.995 1.0989C9.12528 1.3288 10.1414 1.94226 10.8712 2.8354C11.6011 3.72854 11.9999 4.84647 12 5.9999C12 6.8799 12.32 10.1999 13.22 11.9999Z" fill="#1F2937"/>
                </svg>
              </div>
              <span class="text-sm font-medium text-gray-800">Notifications</span>
            </a>
          </router-link>
          <hr class="my-2" />
          <div class="flex items-center h-9 cursor-pointer px-5 hover:bg-gray-50" @click.stop="logoutModalShow = true, dropdownOpen = !dropdownOpen">
            <div class="w-[28px]">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g clip-path="url(#clip0_4202_126392)">
                  <path fill-rule="evenodd" clip-rule="evenodd" d="M6 12.5C6 12.6326 6.05268 12.7598 6.14645 12.8536C6.24021 12.9473 6.36739 13 6.5 13H14.5C14.6326 13 14.7598 12.9473 14.8536 12.8536C14.9473 12.7598 15 12.6326 15 12.5V3.5C15 3.36739 14.9473 3.24021 14.8536 3.14645C14.7598 3.05268 14.6326 3 14.5 3H6.5C6.36739 3 6.24021 3.05268 6.14645 3.14645C6.05268 3.24021 6 3.36739 6 3.5V5.5C6 5.63261 5.94732 5.75979 5.85355 5.85355C5.75979 5.94732 5.63261 6 5.5 6C5.36739 6 5.24021 5.94732 5.14645 5.85355C5.05268 5.75979 5 5.63261 5 5.5V3.5C5 3.10218 5.15804 2.72064 5.43934 2.43934C5.72064 2.15804 6.10218 2 6.5 2H14.5C14.8978 2 15.2794 2.15804 15.5607 2.43934C15.842 2.72064 16 3.10218 16 3.5V12.5C16 12.8978 15.842 13.2794 15.5607 13.5607C15.2794 13.842 14.8978 14 14.5 14H6.5C6.10218 14 5.72064 13.842 5.43934 13.5607C5.15804 13.2794 5 12.8978 5 12.5V10.5C5 10.3674 5.05268 10.2402 5.14645 10.1464C5.24021 10.0527 5.36739 10 5.5 10C5.63261 10 5.75979 10.0527 5.85355 10.1464C5.94732 10.2402 6 10.3674 6 10.5V12.5Z" fill="#DC3545"/>
                  <path fill-rule="evenodd" clip-rule="evenodd" d="M0.146894 8.35414C0.100331 8.3077 0.0633877 8.25252 0.0381813 8.19178C0.0129748 8.13103 0 8.06591 0 8.00014C0 7.93438 0.0129748 7.86926 0.0381813 7.80851C0.0633877 7.74776 0.100331 7.69259 0.146894 7.64614L3.14689 4.64614C3.19338 4.59966 3.24857 4.56278 3.30931 4.53762C3.37005 4.51246 3.43515 4.49951 3.50089 4.49951C3.56664 4.49951 3.63174 4.51246 3.69248 4.53762C3.75322 4.56278 3.80841 4.59966 3.85489 4.64614C3.90138 4.69263 3.93826 4.74782 3.96342 4.80856C3.98858 4.8693 4.00153 4.9344 4.00153 5.00014C4.00153 5.06589 3.98858 5.13099 3.96342 5.19173C3.93826 5.25247 3.90138 5.30766 3.85489 5.35414L1.70789 7.50014H10.5009C10.6335 7.50014 10.7607 7.55282 10.8544 7.64659C10.9482 7.74036 11.0009 7.86754 11.0009 8.00014C11.0009 8.13275 10.9482 8.25993 10.8544 8.3537C10.7607 8.44747 10.6335 8.50014 10.5009 8.50014H1.70789L3.85489 10.6461C3.90138 10.6926 3.93826 10.7478 3.96342 10.8086C3.98858 10.8693 4.00153 10.9344 4.00153 11.0001C4.00153 11.0659 3.98858 11.131 3.96342 11.1917C3.93826 11.2525 3.90138 11.3077 3.85489 11.3541C3.80841 11.4006 3.75322 11.4375 3.69248 11.4627C3.63174 11.4878 3.56664 11.5008 3.50089 11.5008C3.43515 11.5008 3.37005 11.4878 3.30931 11.4627C3.24857 11.4375 3.19338 11.4006 3.14689 11.3541L0.146894 8.35414Z" fill="#DC3545"/>
                </g>
                <defs>
                  <clipPath id="clip0_4202_126392">
                    <rect width="16" height="16" fill="white"/>
                  </clipPath>
                </defs>
              </svg>
            </div>
            <span class="text-sm font-medium text-rose-500">Log Out</span>
          </div>
        </div>
      </div>
    </transition>
    <LogoutModal :modal-open="logoutModalShow" @close-modal="logoutModalShow = false" />
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import { storeToRefs } from 'pinia'
import { useUserStore } from '@/store/User'
import LogoutModal from '@/components/modals/LogoutModal.vue'
import { useDropdownEventHandler } from './DropdownEventHandler';

const userStore = useUserStore()
const { client } = storeToRefs(userStore)
const dropdownOpen = ref(false)
const trigger = ref<HTMLElement | null>(null)
const dropdown = ref<HTMLElement | null>(null)
const logoutModalShow = ref<boolean>(false)

useDropdownEventHandler(dropdownOpen, dropdown, trigger)
</script>